export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const { pathname } = url;

    const setCORSHeaders = (headers) => {
      headers.set("Access-Control-Allow-Origin", "*");
      headers.set("Access-Control-Allow-Methods", "POST, OPTIONS, GET");
      headers.set("Access-Control-Allow-Headers", "Content-Type");
    };

    if (pathname === "/api/addTool") {
      if (request.method === "POST") {
        try {
          const body = await request.json();
          const { name, category, userId } = body;

          await env.DB.prepare("INSERT INTO Tools (name, category, userId) VALUES (?, ?, ?)")
            .bind(name, category, userId)
            .run();

          const headers = new Headers();
          setCORSHeaders(headers);
          headers.set("Content-Type", "application/json");

          return new Response(JSON.stringify({ success: true }), { headers });
        } catch (error) {
          const headers = new Headers();
          setCORSHeaders(headers);
          return new Response(JSON.stringify({ success: false, message: "Error adding tool to the database" }), { headers, status: 500 });
        }
      } else if (request.method === "OPTIONS") {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response(null, { headers });
      } else {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response("Method Not Allowed", { headers, status: 405 });
      }
    }

    if (pathname === "/api/getUserTools") {
      if (request.method === "POST") {
        try {
          const body = await request.json();
          const { userId } = body;

          const { results } = await env.DB.prepare("SELECT * FROM Tools WHERE userId = ?")
            .bind(userId)
            .all();

          const headers = new Headers();
          setCORSHeaders(headers);
          headers.set("Content-Type", "application/json");

          return new Response(JSON.stringify({ success: true, tools: results }), { headers });
        } catch (error) {
          const headers = new Headers();
          setCORSHeaders(headers);
          return new Response(JSON.stringify({ success: false, message: "Error fetching tools from the database" }), { headers, status: 500 });
        }
      } else if (request.method === "OPTIONS") {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response(null, { headers });
      } else {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response("Method Not Allowed", { headers, status: 405 });
      }
    }

    if (pathname === "/api/removeTool") {
      if (request.method === "POST") {
        try {
          const body = await request.json();
          const { toolId, userId } = body;

          await env.DB.prepare("DELETE FROM Tools WHERE id = ? AND userId = ?")
            .bind(toolId, userId)
            .run();

          const headers = new Headers();
          setCORSHeaders(headers);
          headers.set("Content-Type", "application/json");

          return new Response(JSON.stringify({ success: true }), { headers });
        } catch (error) {
          const headers = new Headers();
          setCORSHeaders(headers);
          return new Response(JSON.stringify({ success: false, message: "Error removing tool from the database" }), { headers, status: 500 });
        }
      } else if (request.method === "OPTIONS") {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response(null, { headers });
      } else {
        const headers = new Headers();
        setCORSHeaders(headers);
        return new Response("Method Not Allowed", { headers, status: 405 });
      }
    }

    // Other API endpoints...

    const headers = new Headers();
    setCORSHeaders(headers);
    return new Response("Not Found", { headers, status: 404 });
  }
};
